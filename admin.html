<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>لوحة تحكم صاحب المتجر</title>
<style>
  body {
    font-family: 'Cairo', sans-serif;
    background-color: #fff;
    color: #c62828;
    margin: 20px;
  }
  h2 {
    border-bottom: 2px solid #c62828;
    padding-bottom: 6px;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  input[type="text"], input[type="password"], select {
    width: 100%;
    padding: 8px;
    border: 2px solid #c62828;
    border-radius: 6px;
    box-sizing: border-box;
  }
  button {
    background-color: #c62828;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover {
    background-color: #b71c1c;
  }
  .section-list, .product-list, .orders-list {
    margin-top: 20px;
  }
  .section-item, .product-item, .order-item {
    border: 1px solid #c62828;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .section-item div, .product-item div {
    flex-grow: 1;
  }
  .actions button {
    margin-left: 5px;
    background-color: #2e7d32;
  }
  .actions button.delete-btn {
    background-color: #b71c1c;
  }
  #logoPreview {
    max-width: 150px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #c62828;
  }
  #backgroundPreview {
    max-width: 300px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #c62828;
    display: block;
  }
  .edit-input {
    width: 100%;
    padding: 6px;
    border: 1.5px solid #c62828;
    border-radius: 5px;
  }
</style>
</head>
<body>

<h2>إدارة الأقسام</h2>
<label for="newSectionName">اسم القسم الجديد:</label>
<input type="text" id="newSectionName" placeholder="أدخل اسم القسم" />
<button onclick="addSection()">إضافة قسم</button>

<div class="section-list" id="sectionList"></div>

<hr/>

<h2>إدارة المنتجات</h2>

<label for="productSectionSelect">اختر القسم:</label>
<select id="productSectionSelect"></select>

<label for="productNameInput">اسم المنتج:</label>
<input type="text" id="productNameInput" placeholder="اسم المنتج" />

<label for="productDescInput">وصف المنتج:</label>
<input type="text" id="productDescInput" placeholder="وصف المنتج" />

<label for="productContactInput">رقم التواصل:</label>
<input type="text" id="productContactInput" placeholder="رقم التواصل" />

<label for="productImageInput">صورة المنتج:</label>
<input type="file" id="productImageInput" accept="image/*" />

<label for="productVideoInput">فيديو توضيحي (اختياري):</label>
<input type="file" id="productVideoInput" accept="video/*" />

<button onclick="addProduct()">إضافة منتج</button>

<div class="product-list" id="productList"></div>

<hr/>

<h2>تغيير خلفية صفحة تسجيل الدخول</h2>
<input type="file" id="backgroundInput" accept="image/*" />
<br/>
<img id="backgroundPreview" src="" alt="معاينة الخلفية" />

<hr/>

<h2>رفع شعار المتجر</h2>
<input type="file" id="logoInput" accept="image/*" />
<br/>
<img id="logoPreview" src="" alt="شعار المتجر" />

<hr/>

<h2>عرض الطلبات</h2>
<div class="orders-list" id="ordersList"></div>

<hr/>

<h2>تغيير كلمة سر صاحب المتجر</h2>
<label for="newAdminPass">كلمة السر الجديدة:</label>
<input type="password" id="newAdminPass" placeholder="أدخل كلمة السر الجديدة" />
<button onclick="changeAdminPassword()">تغيير كلمة السر</button>

<hr/>

<button onclick="logout()">تسجيل خروج</button>

<script>
  // متغيرات
  let sections = JSON.parse(localStorage.getItem('sections')) || [];
  let products = JSON.parse(localStorage.getItem('products')) || [];
  let orders = JSON.parse(localStorage.getItem('cart')) || [];
  let adminPassword = localStorage.getItem('adminPassword') || '201088';

  // تحميل الصور والخلفيات
  let storeLogo = localStorage.getItem('storeLogo') || '';
  let loginBackground = localStorage.getItem('loginBackground') || '';

  // عناصر DOM
  const sectionList = document.getElementById('sectionList');
  const productList = document.getElementById('productList');
  const productSectionSelect = document.getElementById('productSectionSelect');
  const ordersList = document.getElementById('ordersList');
  const logoPreview = document.getElementById('logoPreview');
  const backgroundPreview = document.getElementById('backgroundPreview');

  // تحميل الصفحة والبيانات
  window.onload = function() {
    loadSections();
    loadProducts();
    loadLogo();
    loadBackground();
    loadOrders();
    populateProductSectionSelect();
  };

  // -- إدارة الأقسام --
  function loadSections() {
    sectionList.innerHTML = '';
    sections.forEach((sec, index) => {
      const div = document.createElement('div');
      div.className = 'section-item';

      const nameDiv = document.createElement('div');
      nameDiv.textContent = sec;
      nameDiv.contentEditable = false;

      // زر تعديل الاسم
      const editBtn = document.createElement('button');
      editBtn.textContent = 'تعديل';
      editBtn.onclick = () => {
        if(editBtn.textContent === 'تعديل'){
          nameDiv.contentEditable = true;
          nameDiv.focus();
          editBtn.textContent = 'حفظ';
        } else {
          nameDiv.contentEditable = false;
          sections[index] = nameDiv.textContent.trim();
          if(sections[index] === '') {
            alert('اسم القسم لا يمكن أن يكون فارغاً');
            nameDiv.textContent = sections[index];
          } else {
            localStorage.setItem('sections', JSON.stringify(sections));
            alert('تم تعديل القسم');
            // تحديث في منتجات مرتبطه بالقسم القديم
            updateProductsSection(index, sections[index]);
          }
          editBtn.textContent = 'تعديل';
          loadSections();
          populateProductSectionSelect();
          loadProducts();
        }
      };

      // زر حذف القسم
      const delBtn = document.createElement('button');
      delBtn.textContent = 'حذف';
      delBtn.className = 'delete-btn';
      delBtn.onclick = () => {
        if(confirm('هل أنت متأكد من حذف هذا القسم؟ سيتم حذف كل المنتجات المرتبطة به أيضاً.')){
          deleteSection(index);
        }
      };

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';
      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(delBtn);

      div.appendChild(nameDiv);
      div.appendChild(actionsDiv);

      sectionList.appendChild(div);
    });
  }

  function addSection() {
    const newSectionName = document.getElementById('newSectionName').value.trim();
    if(newSectionName === '') {
      alert('يرجى إدخال اسم القسم');
      return;
    }
    if(sections.includes(newSectionName)){
      alert('هذا القسم موجود مسبقاً');
      return;
    }
    sections.push(newSectionName);
    localStorage.setItem('sections', JSON.stringify(sections));
    document.getElementById('newSectionName').value = '';
    loadSections();
    populateProductSectionSelect();
    alert('تم إضافة القسم');
  }

  function deleteSection(index) {
    const deletedSection = sections.splice(index,1)[0];
    // حذف المنتجات المرتبطة بالقسم
    products = products.filter(p => p.section !== deletedSection);
    localStorage.setItem('products', JSON.stringify(products));
    localStorage.setItem('sections', JSON.stringify(sections));
    loadSections();
    populateProductSectionSelect();
    loadProducts();
  }

  // تحديث قسم المنتجات بعد تعديل اسم القسم
  function updateProductsSection(sectionIndex, newSectionName) {
    // لا يمكن معرفة الاسم القديم من index مباشرة إلا إذا حفظنا الاسم القديم قبل التعديل
    // لذلك نعيد تحميل الأقسام مع مقارنة قبل التعديل
    // للحل: هنا نفرض أن الأقسام لم تتغير ترتيبها غير الاسم، ونستبدل منتجات القسم القديم بالاسم الجديد

    // لكن الأفضل قبل تعديل الاسم حفظ الاسم القديم:
    // أضفنا فوق تعديل القسم اسم القسم القديم للاستخدام هنا
    // لذلك نعيد تحميل الأقسام مع حفظ الاسم القديم

    // لتسهيل: نعيد تحميل الأقسام ونعرف القسم القديم من العنصر الذي كان محتوى النص قبل التعديل
    // كحل سريع نعيد تحديث جميع المنتجات حسب الاسم القديم والاسم الجديد

    // بما أنه تم حفظ الاسم الجديد في sections[sectionIndex] فقط

    // الحل العملي: نبحث في المنتجات التي كانت تحمل الاسم القديم، نغيره إلى الجديد
    // هذه نسخة مبسطة (نفترض أن index القسم لم يتغير في الأقسام الأصلية)

    // نحتاج الاسم القديم، لكن لا نستطيع الحصول عليه من هنا (الآن)

    // لأننا نستخدم تعديل مباشر فقط

    // كحل مؤقت: كل منتجات الأقسام المسماة القديمة تتحول إلى الاسم الجديد
    // لكن لأن الاسم القديم لم نحفظه في المتغير، سنعتبر جميع المنتجات للغرض العملي

    // هنا لنفترض أنك حفظت الاسم القديم في متغير sessionStorage

    const oldName = sessionStorage.getItem('editingSectionOldName');
    if(!oldName) return;

    products.forEach(p => {
      if(p.section === oldName) {
        p.section = newSectionName;
      }
    });
    localStorage.setItem('products', JSON.stringify(products));
    sessionStorage.removeItem('editingSectionOldName');
  }

  // عند بداية تعديل القسم، نحفظ الاسم القديم في sessionStorage
  sectionList.addEventListener('focusin', (e) => {
    if(e.target.classList.contains('section-item')){
      sessionStorage.setItem('editingSectionOldName', e.target.textContent.trim());
    }
  }, true);

  // -- إدارة المنتجات --

  function populateProductSectionSelect() {
    productSectionSelect.innerHTML = '';
    sections.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      productSectionSelect.appendChild(opt);
    });
  }

  function loadProducts() {
    productList.innerHTML = '';
    if(products.length === 0) {
      productList.innerHTML = '<p>لا توجد منتجات بعد.</p>';
      return;
    }
    products.forEach((prod, idx) => {
      const div = document.createElement('div');
      div.className = 'product-item';

      const infoDiv = document.createElement('div');
      infoDiv.innerHTML = `<b>${prod.name}</b> (القسم: ${prod.section})`;

      const actionsDiv = document.createElement('div');

      // زر تعديل المنتج
      const editBtn = document.createElement('button');
      editBtn.textContent = 'تعديل';
      editBtn.onclick = () => {
        editProduct(idx);
      };

      // زر حذف المنتج
      const delBtn = document.createElement('button');
      delBtn.textContent = 'حذف';
      delBtn.className = 'delete-btn';
      delBtn.onclick = () => {
        if(confirm('هل تريد حذف هذا المنتج؟')){
          deleteProduct(idx);
        }
      };

      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(delBtn);

      div.appendChild(infoDiv);
      div.appendChild(actionsDiv);
      productList.appendChild(div);
    });
  }

  function addProduct() {
    const section = productSectionSelect.value;
    const name = document.getElementById('productNameInput').value.trim();
    const description = document.getElementById('productDescInput').value.trim();
    const contact = document.getElementById('productContactInput').value.trim();
    const imageFile = document.getElementById('productImageInput').files[0];
    const videoFile = document.getElementById('productVideoInput').files[0];

    if(!section) {
      alert('اختر القسم');
      return;
    }
    if(name === '') {
      alert('أدخل اسم المنتج');
      return;
    }
    if(description === '') {
      alert('أدخل وصف المنتج');
      return;
    }
    if(contact === '') {
      alert('أدخل رقم التواصل');
      return;
    }
    if(!imageFile) {
      alert('اختر صورة للمنتج');
      return;
    }

    // قراءة الصورة والفيديو وتحويلهم إلى بيانات base64
    const readerImage = new FileReader();
    readerImage.onload = function(e) {
      const imageData = e.target.result;
      if(videoFile) {
        const readerVideo = new FileReader();
        readerVideo.onload = function(ev) {
          const videoData = ev.target.result;
          saveProduct(section, name, description, contact, imageData, videoData);
        };
        readerVideo.readAsDataURL(videoFile);
      } else {
        saveProduct(section, name, description, contact, imageData, '');
      }
    };
    readerImage.readAsDataURL(imageFile);
  }

  function saveProduct(section, name, description, contact, imageData, videoData) {
    products.push({
      section,
      name,
      description,
      contact,
      image: imageData,
      video: videoData
    });
    localStorage.setItem('products', JSON.stringify(products));
    alert('تم إضافة المنتج');
    clearProductForm();
    loadProducts();
  }

  function clearProductForm() {
    document.getElementById('productNameInput').value = '';
    document.getElementById('productDescInput').value = '';
    document.getElementById('productContactInput').value = '';
    document.getElementById('productImageInput').value = '';
    document.getElementById('productVideoInput').value = '';
  }

  // تعديل المنتج (نافذة مبسطة)
  function editProduct(idx) {
    const prod = products[idx];
    const newName = prompt('تعديل اسم المنتج:', prod.name);
    if(newName === null) return; // إلغاء
    if(newName.trim() === '') {
      alert('اسم المنتج لا يمكن أن يكون فارغًا');
      return;
    }
    const newDesc = prompt('تعديل وصف المنتج:', prod.description);
    if(newDesc === null) return;
    const newContact = prompt('تعديل رقم التواصل:', prod.contact);
    if(newContact === null) return;

    // لا يمكن تعديل الصور والفيديو بسهولة بدون رفع جديد، يمكن تطوير لاحقاً

    products[idx].name = newName.trim();
    products[idx].description = newDesc.trim();
    products[idx].contact = newContact.trim();

    localStorage.setItem('products', JSON.stringify(products));
    alert('تم تعديل المنتج');
    loadProducts();
  }

  function deleteProduct(idx) {
    products.splice(idx, 1);
    localStorage.setItem('products', JSON.stringify(products));
    loadProducts();
  }

  // -- رفع الشعار --
  document.getElementById('logoInput').addEventListener('change', function() {
    const file = this.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      storeLogo = e.target.result;
      localStorage.setItem('storeLogo', storeLogo);
      logoPreview.src = storeLogo;
      logoPreview.style.display = 'block';
      alert('تم رفع الشعار');
    };
    reader.readAsDataURL(file);
  });

  function loadLogo() {
    if(storeLogo) {
      logoPreview.src = storeLogo;
      logoPreview.style.display = 'block';
    } else {
      logoPreview.style.display = 'none';
    }
  }

  // -- تغيير خلفية تسجيل الدخول --
  document.getElementById('backgroundInput').addEventListener('change', function() {
    const file = this.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      loginBackground = e.target.result;
      localStorage.setItem('loginBackground', loginBackground);
      backgroundPreview.src = loginBackground;
      alert('تم تغيير خلفية تسجيل الدخول');
    };
    reader.readAsDataURL(file);
  });

  function loadBackground() {
    if(loginBackground) {
      backgroundPreview.src = loginBackground;
      backgroundPreview.style.display = 'block';
    } else {
      backgroundPreview.style.display = 'none';
    }
  }

  // -- عرض الطلبات --
  function loadOrders() {
    ordersList.innerHTML = '';
    if(orders.length === 0) {
      ordersList.textContent = 'لا توجد طلبات حالياً.';
      return;
    }
    orders.forEach((order, idx) => {
      const div = document.createElement('div');
      div.className = 'order-item';
      div.innerHTML = `
        <b>المنتج:</b> ${order.product} <br>
        <b>الاسم:</b> ${order.name} <br>
        <b>رقم التواصل:</b> ${order.contact} <br>
        <b>الموقع:</b> ${order.location} <br>
        <b>الوقت:</b> ${order.time}
      `;
      const delBtn = document.createElement('button');
      delBtn.textContent = 'حذف الطلب';
      delBtn.className = 'delete-btn';
      delBtn.onclick = () => {
        if(confirm('هل تريد حذف هذا الطلب؟')) {
          orders.splice(idx,1);
          localStorage.setItem('cart', JSON.stringify(orders));
          loadOrders();
        }
      };
      div.appendChild(delBtn);
      ordersList.appendChild(div);
    });
  }

  // -- تغيير كلمة السر --
  function changeAdminPassword() {
    const newPass = document.getElementById('newAdminPass').value.trim();
    if(newPass.length < 4) {
      alert('يجب أن تكون كلمة السر 4 أحرف على الأقل');
      return;
    }
    adminPassword = newPass;
    localStorage.setItem('adminPassword', adminPassword);
    alert('تم تغيير كلمة السر');
    document.getElementById('newAdminPass').value = '';
  }

  // -- تسجيل الخروج --
  function logout() {
    localStorage.removeItem('loggedIn');
    location.href = 'login.html';
  }

  // عند تعديل القسم، حفظ الاسم القديم
  sectionList.addEventListener('focusin', e => {
    if(e.target && e.target.className === 'section-item') {
      sessionStorage.setItem('editingSectionOldName', e.target.textContent.trim());
    }
  });

</script>

</body>
</html>
