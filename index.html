<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>واجهة المستخدم العادي</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #fff;
      margin: 0;
      padding: 20px;
      color: #c62828;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    #searchBox {
      flex-grow: 1;
      margin-right: 10px;
    }
    #searchBox input {
      width: 100%;
      padding: 10px;
      border: 2px solid #c62828;
      border-radius: 6px;
      font-size: 16px;
    }
    #cartBtn {
      background-color: #c62828;
      border: none;
      color: white;
      padding: 12px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      position: relative;
    }
    #cartCount {
      position: absolute;
      top: 4px;
      right: 8px;
      background: #2e7d32;
      color: white;
      border-radius: 50%;
      padding: 2px 7px;
      font-size: 12px;
      font-weight: bold;
    }
    #logo {
      max-height: 50px;
      margin-bottom: 10px;
    }
    .sectionTitle {
      font-size: 22px;
      margin-top: 25px;
      margin-bottom: 10px;
      border-bottom: 2px solid #c62828;
      padding-bottom: 4px;
    }
    .productsContainer {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .productCard {
      border: 1.5px solid #c62828;
      border-radius: 8px;
      width: 200px;
      padding: 10px;
      flex-shrink: 0;
      background: white;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .productCard img {
      width: 100%;
      height: 130px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .productName {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 5px;
      color: #b71c1c;
      text-align: center;
    }
    /* عرض تفاصيل المنتج */
    #productDetails {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      background: white;
      border: 3px solid #c62828;
      border-radius: 12px;
      padding: 20px;
      z-index: 9999;
      display: none;
    }
    #productDetails img {
      width: 100%;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    #productDetails video {
      width: 100%;
      border-radius: 6px;
      margin-top: 15px;
    }
    #closeDetailsBtn {
      background: #b71c1c;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
    }

    /* سلة الشراء */
    #cartModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 350px;
      max-height: 70vh;
      overflow-y: auto;
      background: white;
      border: 3px solid #2e7d32;
      border-radius: 12px;
      padding: 15px;
      display: none;
      z-index: 10000;
    }
    #cartModal h3 {
      color: #2e7d32;
      margin-top: 0;
    }
    .cartItem {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    .cartItem:last-child {
      border-bottom: none;
    }
    .cartItem button {
      background: #b71c1c;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 5px;
    }

    /* نموذج إضافة طلب */
    #orderForm {
      margin-top: 15px;
      display: none;
    }
    #orderForm input {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #c62828;
      box-sizing: border-box;
    }
    #orderForm button {
      margin-top: 10px;
      width: 100%;
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    /* رسالة الخطأ / النجاح */
    #msgOrder {
      margin-top: 8px;
      font-weight: bold;
      color: green;
      text-align: center;
    }
  </style>
</head>
<body onload="initPage()">

<!-- شعار المتجر -->
<div id="logoContainer" style="text-align:center; margin-bottom: 15px;">
  <img id="logo" src="" alt="شعار المتجر" style="display:none;">
</div>

<header>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="ابحث عن منتج..." oninput="filterProducts()" />
  </div>
  <button id="cartBtn" onclick="toggleCart()">
    سلة الشراء <span id="cartCount">0</span>
  </button>
</header>

<div id="contentContainer"></div>

<!-- تفاصيل المنتج -->
<div id="productDetails">
  <h2 id="detailName"></h2>
  <img id="detailImage" src="" alt="صورة المنتج" />
  <p id="detailDesc"></p>
  <p id="detailContact"></p>
  <video id="detailVideo" controls></video>
  <button id="closeDetailsBtn" onclick="closeDetails()">إغلاق</button>
</div>

<!-- سلة الطلبات -->
<div id="cartModal">
  <h3>طلباتك</h3>
  <div id="cartItems"></div>
  <div id="orderForm">
    <input type="text" id="orderName" placeholder="اسمك" />
    <input type="text" id="orderContact" placeholder="رقم التواصل" />
    <input type="text" id="orderLocation" placeholder="موقعك" />
    <button onclick="submitOrder()">تأكيد الطلب</button>
    <div id="msgOrder"></div>
  </div>
</div>

<script>
  let products = [];
  let sections = [];
  let filteredProducts = [];
  let selectedProductIndex = null;

  function initPage() {
    // تحميل الشعار
    const logoData = localStorage.getItem('storeLogo');
    if(logoData){
      const logoImg = document.getElementById('logo');
      logoImg.src = logoData;
      logoImg.style.display = 'inline-block';
    }

    // تحميل الأقسام والمنتجات
    sections = JSON.parse(localStorage.getItem('sections')) || [];
    products = JSON.parse(localStorage.getItem('products')) || [];
    filteredProducts = [...products];
    renderSectionsAndProducts();
    updateCartCount();
  }

  function renderSectionsAndProducts() {
    const container = document.getElementById('contentContainer');
    container.innerHTML = '';
    if(sections.length === 0) {
      container.innerHTML = '<p>لا توجد أقسام بعد.</p>';
      return;
    }

    sections.forEach(section => {
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'sectionTitle';
      sectionTitle.textContent = section;

      const productsContainer = document.createElement('div');
      productsContainer.className = 'productsContainer';

      const prods = filteredProducts.filter(p => p.section === section);
      if(prods.length === 0){
        const noProdMsg = document.createElement('p');
        noProdMsg.textContent = 'لا توجد منتجات في هذا القسم.';
        productsContainer.appendChild(noProdMsg);
      } else {
        prods.forEach((p, i) => {
          const card = document.createElement('div');
          card.className = 'productCard';
          card.onclick = () => showProductDetails(p, i);

          const img = document.createElement('img');
          img.src = p.image || '';
          img.alt = p.name;

          const name = document.createElement('div');
          name.className = 'productName';
          name.textContent = p.name;

          card.appendChild(img);
          card.appendChild(name);
          productsContainer.appendChild(card);
        });
      }

      container.appendChild(sectionTitle);
      container.appendChild(productsContainer);
    });
  }

  function filterProducts() {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    if(query === '') {
      filteredProducts = [...products];
    } else {
      filteredProducts = products.filter(p => 
        p.name.toLowerCase().includes(query) || 
        p.description.toLowerCase().includes(query)
      );
    }
    renderSectionsAndProducts();
  }

  function showProductDetails(product, index) {
    selectedProductIndex = index;
    document.getElementById('detailName').textContent = product.name;
    document.getElementById('detailImage').src = product.image || '';
    document.getElementById('detailDesc').textContent = product.description;
    document.getElementById('detailContact').textContent = product.contact ? 'رقم التواصل: ' + product.contact : '';
    const video = document.getElementById('detailVideo');
    if(product.video){
      video.src = product.video;
      video.style.display = 'block';
    } else {
      video.style.display = 'none';
      video.src = '';
    }
    document.getElementById('productDetails').style.display = 'block';
  }

  function closeDetails() {
    document.getElementById('productDetails').style.display = 'none';
    selectedProductIndex = null;
  }

  // سلة الطلبات

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  function toggleCart() {
    const cartModal = document.getElementById('cartModal');
    if(cartModal.style.display === 'block') {
      cartModal.style.display = 'none';
      document.getElementById('orderForm').style.display = 'none';
      clearOrderForm();
    } else {
      renderCart();
      cartModal.style.display = 'block';
    }
  }

  function renderCart() {
    const cartItemsDiv = document.getElementById('cartItems');
    cartItemsDiv.innerHTML = '';
    if(cart.length === 0){
      cartItemsDiv.textContent = 'لا توجد طلبات.';
      document.getElementById('orderForm').style.display = 'none';
      return;
    }
    cart.forEach((item, idx) => {
      const div = document.createElement('div');
      div.className = 'cartItem';
      div.innerHTML = `
        <b>المنتج:</b> ${item.product} <br>
        <b>الاسم:</b> ${item.name || '-'} <br>
        <b>رقم التواصل:</b> ${item.contact || '-'} <br>
        <b>الموقع:</b> ${item.location || '-'} <br>
      `;
      const delBtn = document.createElement('button');
      delBtn.textContent = 'حذف الطلب';
      delBtn.onclick = () => {
        if(confirm('هل تريد حذف هذا الطلب؟')){
          deleteCartItem(idx);
        }
      };
      div.appendChild(delBtn);
      cartItemsDiv.appendChild(div);
    });
    // اظهار زر اضافة طلب جديد
    if(selectedProductIndex !== null) {
      document.getElementById('orderForm').style.display = 'block';
    } else {
      document.getElementById('orderForm').style.display = 'none';
    }
  }

  function deleteCartItem(index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
    updateCartCount();
  }

  function updateCartCount() {
    document.getElementById('cartCount').textContent = cart.length;
  }

  function submitOrder() {
    const name = document.getElementById('orderName').value.trim();
    const contact = document.getElementById('orderContact').value.trim();
    const location = document.getElementById('orderLocation').value.trim();

    if(!name || !contact || !location){
      alert('يرجى تعبئة جميع الحقول');
      return;
    }

    const product = filteredProducts[selectedProductIndex];
    if(!product){
      alert('يرجى اختيار منتج صحيح');
      return;
    }

    const order = {
      product: product.name,
      name,
      contact,
      location,
      time: new Date().toLocaleString()
    };

    cart.push(order);
    localStorage.setItem('cart', JSON.stringify(cart));
    clearOrderForm();
    alert('تم إضافة الطلب إلى السلة');
    updateCartCount();
    toggleCart();
  }

  function clearOrderForm() {
    document.getElementById('orderName').value = '';
    document.getElementById('orderContact').value = '';
    document.getElementById('orderLocation').value = '';
    document.getElementById('msgOrder').textContent = '';
  }

</script>

</body>
</html>
